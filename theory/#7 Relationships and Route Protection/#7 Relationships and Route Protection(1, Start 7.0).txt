í”„ë¡œí•„ì— ìŠ¤íƒ€ì¼ë§ì„ ì¡°ê¸ˆ í•´ë³´ì.

< github commit 7.0 ë³µì‚¬ ë¶™ì—¬ë„£ê¸° ìŠ¤íƒ€ì¼ë§ ì™„ë£Œ >

userDetailë¡œ ì™€ë³´ì.

ì•„ë˜ê°€ userDetail ì½”ë“œì„.

block content
    .user-profile
        .user-profile__header
            img.u-avatar(src=user.avatarUrl)
            h4.profile__username=user.name
        if user.id === loggedUser.id
            .user-profile__btns
                a(href=`/users${routes.editProfile}`)
                    button âœï¸ Edit Profile
                a(href=`/users${routes.changePassword}`)
                    button ğŸ”’ Change Password 


ìš°ë¦¬ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ê°€ì§€ê³ ìˆìŒ loggedUserë¼ëŠ”. req.user(í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì •ë³´). 

ê·¸ë¦¬ê³  ê·¸ ì •ë³´ë¡œ getMeí•¨ìˆ˜ì— user : req.userë¡œ ì£¼ê³ ìˆì§€. ë³€ìˆ˜ëª… ê·¸ëŒ€ë¡œ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë€ ëœ»ì„.

ìœ ì €ê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ í…œí”Œë¦¿ì€ loggedUserë¥¼ ì¤Œ. 

ë¡œê·¸ì¸ í•œ ì•„ì´ë””(loggedUser.id)ì™€ viewê°€ ì°¾ì€ ì•„ì´ë””(user.id)ì™€ ê°™ì€ì§€ ë³´ì. ê·¸ ì˜ë¯¸ëŠ” ê°™ì€ ìœ ì €ë¼ëŠ” ëœ»ì„.

userDetailí•¨ìˆ˜ë¥¼ ë³´ë©´ params: {id}ë¥¼ í†µí•´ idë¥¼ ì–»ì„ ìˆ˜ ìˆìŒ.

í˜„ì¬ profileë¡œ ê°€ë³´ë©´ Edit Profileë²„íŠ¼ê³¼ change passwordë²„íŠ¼ì´ ìˆëŠ”ë° ì´ê±´ loggedUser.idì™€ user.idê°€ ê°™ì€ê²½ìš°ì„.

í˜„ì¬ userDetail viewë¥¼ ë¿Œë ¤ì£¼ëŠ” í•¨ìˆ˜ëŠ” getMeì™€ userDetailì„ ë‘ê°€ì§€ê°€ìˆìŒ ì „ìëŠ” req.userë¥¼ userë¡œ ê°€ì§€ê³ ìˆìŒ ì´ì ì„ ìœ ì˜í•˜ì.

í›„ìì˜ userëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ idë¡œ ì°¾ì€ ê°ì²´ì„. getMeë¡œ ë°›ì€ req.userëŠ” loggedUserë¥¼ ê±°ì¹˜ê¸°ë•Œë¬¸ì— ifë¬¸ì—ì„œ ê±¸ëŸ¬ì§ˆìˆ˜ë°–ì— ì—†ìŒ.

ì´ì œ ì§ì ‘ /users/ë‹¤ë¥¸idë¡œ ì ‘ì†í•˜ë©´ ì•„ë°”íƒ€ì™€ ì´ë¦„ì€ ëœ¨ì§€ë§Œ 2ê°œì˜ ë²„íŠ¼ì€ ë³´ì´ì§€ì•ŠìŒ. 

ì´ëŸ° ì›ë¦¬ë¡œ editVideoë²„íŠ¼ë“±ì„ ì²˜ë¦¬í•´ì¤„ê±°ì„. í•˜ì§€ë§Œ ì§€ê¸ˆì€ edit videoì˜ ì‘ì„±ìê°€ ì—†ê¸°ë•Œë¬¸ì— ë‚˜ì¤‘ì— ì²˜ë¦¬í•¨.

==============================#7.0 END====================================

userControllerì—ì„œ editprofile í•¨ìˆ˜ë¥¼ getEditProfileí•¨ìˆ˜ë¡œ ë³€ê²½. ê·¸ë¦¬ê³  postEditProfileë„ ì¶”ê°€.

userRouterë¡œ ê°€ì„œ editProfileí•¨ìˆ˜ë¥¼ -> getEditProfileë¡œ ëª¨ë‘ ë³€ê²½í›„, userRouter.post(~~~)ì˜ ê²½ë¡œë„ ìƒì„± ë¬¼ë¡  í•¨ìˆ˜ëŠ” postEditProfileë¡œ ë“¤ì–´ê°.

ë‹¤ì‹œ userControllerë¡œ ëŒì•„ì™€ì„œ, getEditProfileì€ ë‚´ ì´ë¦„í•˜ê³  ì´ë©”ì¼ì„ ë°˜ë“œì‹œ ë³´ì—¬ì¤˜ì•¼í•¨.

ì™œëƒë©´ ìš°ë¦¬ëŠ” ë²Œì¨ ë¡œê·¸ì¸í•œ ìœ ì €ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë‹ˆê¹. editProfile.pugë¡œ ê°€ì„œ inputì˜ valueê°’ì„ ì •í•´ì£¼ì. getí˜•ì‹ì€ ì•ì„œ ë§í•œëŒ€ë¡œ ê°’ì´ ì´ë¯¸ë“¤ì–´ê°€ìˆì–´ì•¼í•¨

ìš°ë¦¬ëŠ” í˜„ì¬ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ë˜ì„œ í”„ë¡œí•„ì„ ìˆ˜ì •í•˜ëŠ”ê±°ê¸°ë•Œë¬¸ì— ë¡œì»¬ì˜ loggedUserë¥¼ ì“¸ìˆ˜ìˆìŒ ì´ë¦„ê³¼ ì´ë©”ì¼ inputì— valueë¥¼ ì •í•´ì£¼ì (loggedUser.email, name)

ì•„ë°”íƒ€ ë¶€ë¶„ë„ ë°”ê¿€ ìˆ˜ ìˆê²Œ í•´ì£¼ì. ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì•¼í•¨.

const multerAvatar = multer({ dest: "uploads/avatars/" }); ê²½ë¡œë¥¼ ì¡ì•„ì£¼ê³ 

export const uploadAvatar = multerAvatar.single("avatar"); uploadAvatarë¥¼ exportì‹œì¼œì£¼ì.

avatarì¸ì´ìœ ëŠ” í•„ë“œì´ë¦„ì´ avatarì´ê¸°ë•Œë¬¸. 

ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì—ˆìœ¼ë©´ ì‚¬ìš©í•˜ì. userRouterë¡œ ì´ë™ postì— uploadAvatarë„£ì–´ì¤Œ. Videoí–ˆë˜ê²ƒì²˜ëŸ¼ ë˜‘ê°™ìŒ.

postEditProfile í•¨ìˆ˜ì—ì„œ reqë¡œ ë°›ì€ì •ë³´ë¥¼ ì‚¬ìš©í•´ë³´ì Multerê°€ ì£¼ëŠ”ê±°ì„. const{...} = req;

bodyì—ì„œ name, email ê·¸ë¦¬ê³  fileì˜ path

try,catch êµ¬ë¬¸ê³¼ async, awaitêµ¬ë¬¸ì„ ì‚¬ìš©í•˜ê³  errorë¥¼ ì¡ì•˜ì„ë• ë‹¤ì‹œ editprofileë¡œ ëŒì•„ê°€ë„ë¡.

ì—¬ê¸°ì„œ ëŒì•„ê°ˆë•Œ renderë¥¼ì“°ëŠ”ë° renderëŠ” í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ê³  redirectëŠ” URLë¡œ ëŒì•„ê°€ëŠ”ê±°ì„.

export const postEditProfile = async (req, res) => {
  const {
    body: { name, email },
    file
  } = req;
  try {
    await User.findByIdAndUpdate(req.user.id, {
      name,
      email,
      avatarUrl: file ? file.path : req.user.avatarUrl
    });
    res.redirect(routes.me);
  } catch (error) {
    res.render("editProfile", { pageTitle: "Edit Profile" });
  }
};

ë‹¤ìŒì´ postEditProfileì˜ í•¨ìˆ˜ì¸ë° reqë¡œ ë°›ì€ ë°ì´í„° (postë¡œ ë„˜ê²¨ì£¼ê³  ê·¸ ìš”ì²­ì„ ì´í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ëŠ”ê±°ì„)

reqì—ì„œ bodyì—ìˆëŠ” name, emailê³¼ file ê·¸ìì²´ë¥¼ ë°›ìŒ.

try, catchë¡œ ì²˜ë¦¬í•˜ê³  errorë‚¬ì„ë• ë‹¤ì‹œ editProfileì„ renderí•´ì¤˜ì•¼í•¨. redirectì•„ë‹˜. í…œí”Œë¦¿ì„  ë°›ëŠ”ê±°ê¸°ë•Œë¬¸.

ë¹„ë™ê¸°êµ¬ë¬¸ìœ¼ë¡œ req.user.id (í˜„ì¬ì‚¬ìš©ìì˜ id)ë¥¼ ì°¾ìœ¼ë©´ì„œ name, email, avatarUrlì„ findByIdAndUpdate ì²˜ë¦¬í•˜ëŠ”ê±°ì„ ëª½êµ¬ìŠ¤ ì¿¼ë¦¬ì„.

í”„ë¡œí•„ì„ ìˆ˜ì •í•  ë•Œ. avatarUrl : path ì´ëŸ°ì‹ìœ¼ë¡œ ë„£ì–´ì£¼ë©´. ë‚´ê°€ ì•„ë°”íƒ€ì‚¬ì§„ì„ ìˆ˜ì •ì•ˆí•˜ê³  ë„˜ê²¼ì„ë•Œ nullë¡œ ê°„ì£¼í•˜ê²Œ ë˜ê¸°ë•Œë¬¸. ì¦‰ ì´ì „ê»„ ì§€ìš´ë‹¤ëŠ” ë§ì„.

ë‹¤ì‹œí•œë²ˆ ì •ë¦¬í•˜ë©´ fileì´ ìˆìœ¼ë©´ file.path, íŒŒì¼ì´ ì—†ìœ¼ë©´ í˜„ì¬ ì•„ë°”íƒ€ì‚¬ì§„ ì¦‰ req.user.avatarUrlë¡œ í•˜ë©´ë¨.

ì—¬ê¸°ê¹Œì§€ í•¨ìˆ˜ì˜ ì‘ì„±ì´ ëì´ë‚¨.

upload.pugë¡œê°€ì„œ formì— enctype="multipart/form-data"ë¥¼ ì¶”ê°€í•´ì•¼í•¨. formì—ì„œ íŒŒì¼ì„ ë„˜ê¸¸ë•Œ ì¸ì½”ë”©ì´ ë‹¬ë¼ì•¼í•˜ê¸°ë•Œë¬¸.

ê·¸ë¦¬ê³  editProfile.pugì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ë„£ì„ inputì—ëŠ” accept="image/"ë¥¼ ë„£ì–´ì¤Œ. í”„ë¡œí•„ì— ì´ë¯¸ì§€íŒŒì¼ë§Œ í•„ìš”í•˜ê¸° ë•Œë¬¸.

==============================#7.1 END====================================

ì´ì œ changePasswordë¶€ë¶„ì„ í•´ë³´ì. ì´ê±¸ í•˜ê¸°ìœ„í•´ ìš°ë¦¬ëŠ” passport-local-mongooseì˜ changePasswordë¥¼ì“¸ê±°ì„.

changePassword(oldPassword, newPassword, [cb]) ì„.

íŒ¨ìŠ¤ì›Œë“œëŠ” ì ˆëŒ€ë¡œ í…ìŠ¤íŠ¸ë¡œ ì €ì¥ë˜ì§€ì•Šê³  ì•”í˜¸í™” ë˜ì„œ ì €ì¥ ë¨.

userControllerì˜ Changepasswordí•¨ìˆ˜ë„ get, postë¡œ ë”°ë¡œ ë§Œë“¤ì–´ì¤Œ.

ë§Œë“¤ì–´ì§„ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼í•˜ë‹ˆ userRouterë¡œê°€ì„œ ìˆ˜ì •í•˜ì get, postí˜•ì‹ìœ¼ë¡œ ë‘ ê°€ì§€ ê²½ë¡œë¥¼ë§Œë“¤ê³  ê°ì getChange, postChangeí•¨ìˆ˜ë¥¼ ë„£ì–´ì¤Œ.

ì´ì œ postChangePasswordí•¨ìˆ˜ë¥¼ ì‘ì„±í•´ì•¼í•¨. ë¹„ë™ê¸°ì‹ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ê¸°ì „ì— í…œí”Œë¦¿ì´ ë Œë”ë˜ë©´ì•ˆë˜ë‹ˆê¹Œ.

export const postChangePassword = async (req, res) => {
  const {
    body: { oldPassword, newPassword, newPassword2 }
  } = req;
  try {
    if (newPassword !== newPassword2) {
      res.status(400);
      res.redirect(routes.changePassword);
    } else {
      await req.user.changePassword(oldPassword, newPassword);
      res.redirect(routes.home);
    }
  } catch (error) {
    res.status(400);
    res.redirect(routes.changePassword);
  }
};

ìœ„ì™€ ê°™ì€ ì½”ë“œëŠ” passport-local-mongooseì˜ changePasswordí•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©° ë§Œë“  postChangePasswordí•¨ìˆ˜ì„.

ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ê¸°ì „ì— homeìœ¼ë¡œ ëŒì•„ê°€ë©´ì•ˆë˜ë‹ˆ ë¹„ë™ê¸°êµ¬ë¬¸ì„ ì‚¬ìš©í–ˆê³ , ë°›ì€ ìš”ì²­ì„ í†µí•˜ì—¬ bodyì—ì„œ í•´ë‹¹ ì¸ìë“¤ì„êº¼ëƒˆìŒ

ifë¬¸ì€ ë¹„ë°€ë²ˆí˜¸ì˜ í™•ì¸êµ¬ë¬¸ì´ê³  ì‹¤íŒ¨í–ˆì„ì‹œ ìƒíƒœë¥¼ë³´ë‚´ê³  ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í™”ë©´ìœ¼ë¡œ

ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ëìœ¼ë©´, ë¹„ë™ê¸°êµ¬ë¬¸ìœ¼ë¡œ changePasswordí•¨ìˆ˜ë¥¼ í†µí•´ ë°”ê¾¸ê³  homeìœ¼ë¡œ ë³´ëƒ„.

catchêµ¬ë¬¸ë„ ê°„ë‹¨í•˜ë‹¤ errorë°œìƒì‹œ ìƒíƒœì½”ë“œ ë³´ë‚´ê³  ë‹¤ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í™”ë©´ìœ¼ë¡œ. ë.

==============================#7.2 END====================================
